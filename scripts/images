#!/bin/bash
set -e

# Map ARCH to Docker platform
arch_to_platform() {
    case "$1" in
        amd64) echo "linux/amd64" ;;
        arm64) echo "linux/arm64" ;;
        arm)   echo "linux/arm/v7" ;;
        *)     echo "linux/$1" ;;
    esac
}

build_all()
{
    if [ "$#" = 0 ]; then
        set -- [0-9][0-9]*
    fi

    # Determine if we should use buildx (for cross-compilation)
    PLATFORM=$(arch_to_platform ${ARCH})
    HOST_ARCH=$(uname -m)
    case "$HOST_ARCH" in
        x86_64)  HOST_ARCH="amd64" ;;
        aarch64) HOST_ARCH="arm64" ;;
    esac

    # Use buildx if explicitly requested or if cross-compiling
    if [ "${USE_BUILDX}" = "1" ] || [ "${ARCH}" != "${HOST_ARCH}" ]; then
        echo "Using Docker buildx for ${ARCH} (platform: ${PLATFORM})"
        USE_BUILDX=1
    fi

    for i; do
        i=$(basename $i)
        IMAGE=${i##[0-9][0-9]-}
        FULL_IMAGE=$REPO/macula-$IMAGE:$TAG

        cd $i
        if [ -e archs ] && ! grep -w -q $ARCH archs; then
            echo skipping $FULL_IMAGE for $ARCH
            cd ..
            continue
        fi

        echo building $FULL_IMAGE
        ROOT=.
        if [ -e root ]; then
            ROOT=$(readlink -f root)
        fi

        if [ "${USE_BUILDX}" = "1" ]; then
            # Use buildx for cross-compilation
            docker buildx build \
                --platform ${PLATFORM} \
                --build-arg TAG=$TAG \
                --build-arg VERSION=${VERSION} \
                --build-arg REPO=${REPO} \
                --build-arg ARCH=${ARCH} \
                --build-arg TARGETARCH=${ARCH} \
                -f $(pwd)/Dockerfile \
                -t $FULL_IMAGE \
                --load \
                $ROOT
        else
            # Use regular docker build for native builds
            docker build \
                --build-arg TAG=$TAG \
                --build-arg VERSION=${VERSION} \
                --build-arg REPO=${REPO} \
                --build-arg ARCH=${ARCH} \
                -f $(pwd)/Dockerfile \
                -t $FULL_IMAGE \
                $ROOT
        fi
        cd ..
    done
}

copy_all()
{
    OUTPUT=$1
    shift

    if [ "$#" = 0 ]; then
        set -- [0-9][0-9]*
    fi

    for i; do
        i=$(basename $i)
        IMAGE=${i##[0-9][0-9]-}
        FULL_IMAGE=$REPO/macula-$IMAGE:$TAG

        cd $i
        if [ -e archs ] && ! grep -w -q $ARCH archs; then
            echo skipping $FULL_IMAGE for $ARCH
            cd ..
            continue
        fi

        echo building $FULL_IMAGE
        ID=$(docker create $FULL_IMAGE)
        echo $(readlink -f ${OUTPUT})
        rm -rf output
        docker cp ${ID}:/output .
        docker rm -fv $ID
        cp ./output/* ${OUTPUT}/
        rm -rf ./output
        cd ..
    done
}
